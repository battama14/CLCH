<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Service Worker v2</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1, h2 {
      color: #333;
    }
    .card {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px 10px 0;
    }
    button:hover {
      background-color: #45a049;
    }
    .log {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 20px;
      font-family: monospace;
      background-color: #f5f5f5;
    }
    .step {
      margin-bottom: 30px;
    }
    .step-number {
      display: inline-block;
      width: 30px;
      height: 30px;
      background-color: #4CAF50;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      margin-right: 10px;
    }
    .status {
      padding: 8px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .error {
      background-color: #ffebee;
      color: #c62828;
    }
    .warning {
      background-color: #fff8e1;
      color: #f57f17;
    }
    .info {
      background-color: #e3f2fd;
      color: #1565c0;
    }
  </style>
</head>
<body>
  <h1>Test Service Worker v2</h1>
  
  <div class="card">
    <div class="step">
      <h2><span class="step-number">1</span>Vérifier le support du navigateur</h2>
      <div id="browser-support" class="status">Vérification...</div>
      <button id="check-support">Vérifier le support</button>
    </div>
    
    <div class="step">
      <h2><span class="step-number">2</span>Vérifier les Service Workers existants</h2>
      <div id="sw-list" class="status">Non vérifié</div>
      <button id="check-sw">Vérifier les Service Workers</button>
    </div>
    
    <div class="step">
      <h2><span class="step-number">3</span>Enregistrer le Service Worker</h2>
      <div id="sw-status" class="status">Non enregistré</div>
      <button id="register-sw">Enregistrer firebase-messaging-sw.js</button>
    </div>
    
    <div class="step">
      <h2><span class="step-number">4</span>Demander la permission</h2>
      <div id="permission-status" class="status">Non demandée</div>
      <button id="request-permission">Demander la permission</button>
    </div>
    
    <div class="step">
      <h2><span class="step-number">5</span>Envoyer une notification de test</h2>
      <div id="notification-status" class="status">Non envoyée</div>
      <button id="send-notification">Envoyer une notification</button>
    </div>
    
    <div class="step">
      <h2><span class="step-number">6</span>Nettoyer les Service Workers</h2>
      <button id="unregister-sw">Supprimer tous les Service Workers</button>
    </div>
  </div>
  
  <h2>Logs</h2>
  <div id="log" class="log">Logs apparaîtront ici...</div>
  
  <script>
    // Éléments DOM
    const browserSupport = document.getElementById('browser-support');
    const swList = document.getElementById('sw-list');
    const swStatus = document.getElementById('sw-status');
    const permissionStatus = document.getElementById('permission-status');
    const notificationStatus = document.getElementById('notification-status');
    const logElement = document.getElementById('log');
    
    // Fonction pour ajouter des logs
    function log(message) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      logElement.innerHTML += `[${time}] ${message}<br>`;
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    // Fonction pour mettre à jour le statut
    function updateStatus(element, message, type) {
      element.textContent = message;
      element.className = 'status ' + type;
    }
    
    // Étape 1: Vérifier le support du navigateur
    document.getElementById('check-support').addEventListener('click', checkSupport);
    
    function checkSupport() {
      log('Vérification du support du navigateur...');
      
      let supported = true;
      let reasons = [];
      
      // Vérifier le support du service worker
      if (!('serviceWorker' in navigator)) {
        supported = false;
        reasons.push('Service Worker non supporté');
      }
      
      // Vérifier le support des notifications
      if (!('Notification' in window)) {
        supported = false;
        reasons.push('Notifications non supportées');
      }
      
      // Vérifier si nous sommes en HTTPS
      if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        supported = false;
        reasons.push('HTTPS requis (sauf sur localhost)');
      }
      
      // Afficher le résultat
      if (supported) {
        updateStatus(browserSupport, '✅ Votre navigateur supporte les Service Workers et les Notifications', 'success');
        log('✅ Votre navigateur supporte les Service Workers et les Notifications');
      } else {
        updateStatus(browserSupport, `❌ Votre navigateur ne supporte pas: ${reasons.join(', ')}`, 'error');
        log(`❌ Votre navigateur ne supporte pas: ${reasons.join(', ')}`);
      }
    }
    
    // Étape 2: Vérifier les Service Workers existants
    document.getElementById('check-sw').addEventListener('click', checkServiceWorkers);
    
    function checkServiceWorkers() {
      log('Vérification des Service Workers existants...');
      
      if (!('serviceWorker' in navigator)) {
        updateStatus(swList, '❌ Service Workers non supportés par ce navigateur', 'error');
        log('❌ Service Workers non supportés par ce navigateur');
        return;
      }
      
      navigator.serviceWorker.getRegistrations().then(registrations => {
        if (registrations.length === 0) {
          updateStatus(swList, '⚠️ Aucun Service Worker enregistré', 'warning');
          log('⚠️ Aucun Service Worker enregistré');
        } else {
          let message = `✅ ${registrations.length} Service Worker(s) enregistré(s):<br>`;
          log(`✅ ${registrations.length} Service Worker(s) enregistré(s):`);
          
          registrations.forEach((reg, i) => {
            const state = reg.active ? 'actif' : reg.installing ? 'en installation' : reg.waiting ? 'en attente' : 'inconnu';
            message += `<br>${i+1}. Scope: ${reg.scope}<br>État: ${state}`;
            log(`   ${i+1}. Scope: ${reg.scope}, État: ${state}`);
          });
          
          updateStatus(swList, message, 'info');
        }
      }).catch(error => {
        updateStatus(swList, `❌ Erreur: ${error.message}`, 'error');
        log(`❌ Erreur lors de la vérification des Service Workers: ${error.message}`);
      });
    }
    
    // Étape 3: Enregistrer le Service Worker
    document.getElementById('register-sw').addEventListener('click', registerServiceWorker);
    
    function registerServiceWorker() {
      log('Enregistrement du Service Worker firebase-messaging-sw.js...');
      
      if (!('serviceWorker' in navigator)) {
        updateStatus(swStatus, '❌ Service Workers non supportés par ce navigateur', 'error');
        log('❌ Service Workers non supportés par ce navigateur');
        return;
      }
      
      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(registration => {
          updateStatus(swStatus, `✅ Service Worker enregistré avec succès! Scope: ${registration.scope}`, 'success');
          log(`✅ Service Worker enregistré avec succès! Scope: ${registration.scope}`);
          
          // Vérifier l'état du service worker
          if (registration.installing) {
            log('Service Worker en cours d\'installation');
          } else if (registration.waiting) {
            log('Service Worker en attente d\'activation');
          } else if (registration.active) {
            log('Service Worker actif');
          }
        })
        .catch(error => {
          updateStatus(swStatus, `❌ Erreur: ${error.message}`, 'error');
          log(`❌ Erreur lors de l'enregistrement du Service Worker: ${error.message}`);
        });
    }
    
    // Étape 4: Demander la permission
    document.getElementById('request-permission').addEventListener('click', requestPermission);
    
    function requestPermission() {
      log('Demande de permission de notification...');
      
      if (!('Notification' in window)) {
        updateStatus(permissionStatus, '❌ Notifications non supportées par ce navigateur', 'error');
        log('❌ Notifications non supportées par ce navigateur');
        return;
      }
      
      Notification.requestPermission()
        .then(permission => {
          if (permission === 'granted') {
            updateStatus(permissionStatus, '✅ Permission de notification accordée', 'success');
            log('✅ Permission de notification accordée');
          } else if (permission === 'denied') {
            updateStatus(permissionStatus, '❌ Permission de notification refusée', 'error');
            log('❌ Permission de notification refusée');
          } else {
            updateStatus(permissionStatus, '⚠️ Permission de notification ignorée', 'warning');
            log('⚠️ Permission de notification ignorée');
          }
        })
        .catch(error => {
          updateStatus(permissionStatus, `❌ Erreur: ${error.message}`, 'error');
          log(`❌ Erreur lors de la demande de permission: ${error.message}`);
        });
    }
    
    // Étape 5: Envoyer une notification de test
    document.getElementById('send-notification').addEventListener('click', sendNotification);
    
    function sendNotification() {
      log('Envoi d\'une notification de test...');
      
      if (!('Notification' in window)) {
        updateStatus(notificationStatus, '❌ Notifications non supportées par ce navigateur', 'error');
        log('❌ Notifications non supportées par ce navigateur');
        return;
      }
      
      if (Notification.permission !== 'granted') {
        updateStatus(notificationStatus, '❌ Permission de notification non accordée', 'error');
        log('❌ Permission de notification non accordée. Demandez d\'abord la permission.');
        return;
      }
      
      try {
        // Créer une notification
        const notification = new Notification('Test de notification', {
          body: 'Ceci est une notification de test',
          icon: '/favicon.ico',
          badge: '/favicon.ico',
          vibrate: [200, 100, 200],
          tag: 'test-notification'
        });
        
        notification.onclick = () => {
          log('Notification cliquée');
          notification.close();
          window.focus();
        };
        
        updateStatus(notificationStatus, '✅ Notification envoyée avec succès', 'success');
        log('✅ Notification envoyée avec succès');
      } catch (error) {
        updateStatus(notificationStatus, `❌ Erreur: ${error.message}`, 'error');
        log(`❌ Erreur lors de l'envoi de la notification: ${error.message}`);
      }
    }
    
    // Étape 6: Nettoyer les Service Workers
    document.getElementById('unregister-sw').addEventListener('click', unregisterServiceWorkers);
    
    function unregisterServiceWorkers() {
      log('Suppression de tous les Service Workers...');
      
      if (!('serviceWorker' in navigator)) {
        log('❌ Service Workers non supportés par ce navigateur');
        return;
      }
      
      navigator.serviceWorker.getRegistrations().then(registrations => {
        if (registrations.length === 0) {
          log('⚠️ Aucun Service Worker à supprimer');
          return;
        }
        
        let promises = [];
        registrations.forEach(registration => {
          log(`Suppression du Service Worker: ${registration.scope}`);
          promises.push(registration.unregister());
        });
        
        Promise.all(promises).then(results => {
          const successCount = results.filter(result => result === true).length;
          log(`✅ ${successCount}/${registrations.length} Service Worker(s) supprimé(s)`);
          
          // Vérifier à nouveau les Service Workers
          checkServiceWorkers();
        });
      }).catch(error => {
        log(`❌ Erreur lors de la suppression des Service Workers: ${error.message}`);
      });
    }
    
    // Vérifier automatiquement le support au chargement
    window.addEventListener('load', () => {
      checkSupport();
      checkServiceWorkers();
      
      // Vérifier l'état de la permission de notification
      if ('Notification' in window) {
        const permission = Notification.permission;
        if (permission === 'granted') {
          updateStatus(permissionStatus, '✅ Permission de notification déjà accordée', 'success');
        } else if (permission === 'denied') {
          updateStatus(permissionStatus, '❌ Permission de notification refusée', 'error');
        } else {
          updateStatus(permissionStatus, '⚠️ Permission de notification non demandée', 'warning');
        }
      }
    });
  </script>
</body>
</html>