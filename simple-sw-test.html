<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Simple du Service Worker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
    }
    .result {
      margin: 20px 0;
      padding: 15px;
      border-radius: 5px;
      background-color: #f5f5f5;
      border-left: 4px solid #ccc;
    }
    .success {
      border-left-color: #4CAF50;
      background-color: #e8f5e9;
    }
    .error {
      border-left-color: #f44336;
      background-color: #ffebee;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px 10px 0;
    }
    button:hover {
      background-color: #45a049;
    }
    pre {
      background-color: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    #log {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 20px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>Test Simple du Service Worker</h1>
  
  <div id="status" class="result">Vérification du service worker...</div>
  
  <button id="register-sw">Étape 1: Enregistrer le Service Worker</button>
  <button id="request-permission">Étape 2: Demander la permission</button>
  <button id="send-notification">Étape 3: Envoyer une notification</button>
  <button id="clear-sw">Supprimer les Service Workers</button>
  
  <div id="log">Logs apparaîtront ici...</div>
  
  <script>
    const status = document.getElementById('status');
    const log = document.getElementById('log');
    
    function addLog(message) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      log.innerHTML += `[${time}] ${message}<br>`;
      log.scrollTop = log.scrollHeight;
    }
    
    // Vérifier si le service worker est pris en charge
    if ('serviceWorker' in navigator) {
      status.textContent = 'Service Worker pris en charge par ce navigateur';
      status.classList.add('success');
      addLog('Service Worker pris en charge ✓');
      
      // Vérifier les service workers existants
      checkServiceWorkers();
    } else {
      status.textContent = 'Service Worker NON pris en charge par ce navigateur';
      status.classList.add('error');
      addLog('Service Worker NON pris en charge ✗');
    }
    
    function checkServiceWorkers() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          if (registrations.length === 0) {
            addLog('Aucun Service Worker enregistré');
          } else {
            addLog(`${registrations.length} Service Worker(s) enregistré(s)`);
            registrations.forEach((reg, i) => {
              addLog(`SW ${i+1}: Scope: ${reg.scope}`);
            });
          }
        });
      }
    }
    
    // Enregistrer le service worker
    document.getElementById('register-sw').addEventListener('click', () => {
      if ('serviceWorker' in navigator) {
        addLog('Tentative d\'enregistrement du Service Worker...');
        
        // Créer un service worker simple
        const swContent = `
          // Service Worker simple pour test
          self.addEventListener('install', event => {
            console.log('Service Worker installé');
            self.skipWaiting();
          });
          
          self.addEventListener('activate', event => {
            console.log('Service Worker activé');
            return self.clients.claim();
          });
          
          self.addEventListener('push', event => {
            console.log('Notification push reçue', event);
            
            const title = 'Test de notification';
            const options = {
              body: 'Ceci est une notification de test',
              icon: '/favicon.ico'
            };
            
            event.waitUntil(
              self.registration.showNotification(title, options)
            );
          });
          
          self.addEventListener('notificationclick', event => {
            console.log('Notification cliquée', event);
            event.notification.close();
            
            event.waitUntil(
              clients.matchAll({type: 'window'}).then(clientList => {
                if (clientList.length > 0) {
                  return clientList[0].focus();
                }
                return clients.openWindow('/');
              })
            );
          });
        `;
        
        // Créer un Blob avec le contenu du service worker
        const blob = new Blob([swContent], {type: 'text/javascript'});
        const swUrl = URL.createObjectURL(blob);
        
        // Enregistrer le service worker
        navigator.serviceWorker.register(swUrl)
          .then(registration => {
            addLog(`Service Worker enregistré avec succès! Scope: ${registration.scope}`);
            status.textContent = 'Service Worker enregistré avec succès!';
            status.classList.add('success');
            
            // Libérer l'URL
            URL.revokeObjectURL(swUrl);
            
            // Vérifier les service workers
            checkServiceWorkers();
          })
          .catch(error => {
            addLog(`Erreur lors de l'enregistrement du Service Worker: ${error.message}`);
            status.textContent = `Erreur: ${error.message}`;
            status.classList.add('error');
            
            // Libérer l'URL
            URL.revokeObjectURL(swUrl);
          });
      }
    });
    
    // Demander la permission de notification
    document.getElementById('request-permission').addEventListener('click', () => {
      if ('Notification' in window) {
        addLog('Demande de permission de notification...');
        
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            addLog('Permission de notification accordée ✓');
            status.textContent = 'Permission de notification accordée';
            status.classList.add('success');
          } else {
            addLog(`Permission de notification ${permission} ✗`);
            status.textContent = `Permission de notification ${permission}`;
            status.classList.add('error');
          }
        });
      } else {
        addLog('Notifications non prises en charge par ce navigateur ✗');
      }
    });
    
    // Envoyer une notification
    document.getElementById('send-notification').addEventListener('click', () => {
      if ('Notification' in window && Notification.permission === 'granted') {
        addLog('Envoi d\'une notification...');
        
        // Créer une notification simple
        const notification = new Notification('Test de notification', {
          body: 'Ceci est une notification de test locale',
          icon: '/favicon.ico'
        });
        
        notification.onclick = () => {
          addLog('Notification cliquée');
          notification.close();
        };
        
        addLog('Notification envoyée ✓');
      } else {
        addLog('Impossible d\'envoyer une notification. Vérifiez les permissions ✗');
      }
    });
    
    // Supprimer les service workers
    document.getElementById('clear-sw').addEventListener('click', () => {
      if ('serviceWorker' in navigator) {
        addLog('Suppression des Service Workers...');
        
        navigator.serviceWorker.getRegistrations().then(registrations => {
          const promises = registrations.map(registration => {
            return registration.unregister();
          });
          
          Promise.all(promises).then(() => {
            addLog('Tous les Service Workers ont été supprimés ✓');
            checkServiceWorkers();
          });
        });
      }
    });
  </script>
</body>
</html>