<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vérification du Service Worker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
    }
    .result {
      margin: 20px 0;
      padding: 15px;
      border-radius: 5px;
      background-color: #f5f5f5;
      border-left: 4px solid #ccc;
    }
    .success {
      border-left-color: #4CAF50;
      background-color: #e8f5e9;
    }
    .error {
      border-left-color: #f44336;
      background-color: #ffebee;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    pre {
      background-color: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Vérification du Service Worker</h1>
  
  <div id="sw-status" class="result">Vérification du service worker...</div>
  
  <div id="notification-status" class="result">Vérification des permissions de notification...</div>
  
  <button id="register-sw">Enregistrer le Service Worker</button>
  <button id="request-permission">Demander la permission de notification</button>
  
  <h2>Service Workers enregistrés</h2>
  <pre id="sw-list">Chargement...</pre>
  
  <script>
    // Vérifier si le navigateur prend en charge les service workers
    const swStatus = document.getElementById('sw-status');
    const notificationStatus = document.getElementById('notification-status');
    const swList = document.getElementById('sw-list');
    
    function updateSwList() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          if (registrations.length === 0) {
            swList.textContent = 'Aucun Service Worker enregistré';
          } else {
            let text = `${registrations.length} Service Worker(s) enregistré(s):\n\n`;
            registrations.forEach((reg, i) => {
              text += `${i+1}. Scope: ${reg.scope}\n`;
              text += `   État: ${reg.active ? 'Actif' : reg.installing ? 'Installation' : reg.waiting ? 'En attente' : 'Inconnu'}\n`;
              text += `   Mode de mise à jour: ${reg.updateViaCache}\n\n`;
            });
            swList.textContent = text;
          }
        });
      } else {
        swList.textContent = 'Les Service Workers ne sont pas pris en charge par ce navigateur';
      }
    }
    
    // Vérifier si le service worker est pris en charge
    if ('serviceWorker' in navigator) {
      swStatus.textContent = 'Service Worker pris en charge par ce navigateur';
      swStatus.classList.add('success');
      
      // Vérifier les service workers existants
      updateSwList();
    } else {
      swStatus.textContent = 'Service Worker NON pris en charge par ce navigateur';
      swStatus.classList.add('error');
    }
    
    // Vérifier les permissions de notification
    if ('Notification' in window) {
      const permission = Notification.permission;
      
      if (permission === 'granted') {
        notificationStatus.textContent = 'Permissions de notification accordées';
        notificationStatus.classList.add('success');
      } else if (permission === 'denied') {
        notificationStatus.textContent = 'Permissions de notification refusées';
        notificationStatus.classList.add('error');
      } else {
        notificationStatus.textContent = 'Permissions de notification non demandées';
      }
    } else {
      notificationStatus.textContent = 'Notifications NON prises en charge par ce navigateur';
      notificationStatus.classList.add('error');
    }
    
    // Bouton pour enregistrer le service worker
    document.getElementById('register-sw').addEventListener('click', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
          .then(registration => {
            alert(`Service Worker enregistré avec succès!\nScope: ${registration.scope}`);
            updateSwList();
          })
          .catch(error => {
            alert(`Erreur lors de l'enregistrement du Service Worker: ${error.message}`);
          });
      } else {
        alert('Les Service Workers ne sont pas pris en charge par ce navigateur');
      }
    });
    
    // Bouton pour demander la permission de notification
    document.getElementById('request-permission').addEventListener('click', () => {
      if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            notificationStatus.textContent = 'Permissions de notification accordées';
            notificationStatus.classList.add('success');
            notificationStatus.classList.remove('error');
            
            // Envoyer une notification de test
            new Notification('Test de notification', {
              body: 'Cette notification confirme que les permissions sont accordées',
              icon: '/favicon.ico'
            });
          } else {
            notificationStatus.textContent = 'Permissions de notification refusées ou ignorées';
            notificationStatus.classList.add('error');
            notificationStatus.classList.remove('success');
          }
        });
      } else {
        alert('Les notifications ne sont pas prises en charge par ce navigateur');
      }
    });
  </script>
</body>
</html>