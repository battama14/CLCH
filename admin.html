<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLCH Admin - Validation des Photos</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="fonts/fonts.css">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'A Attack Graffiti', 'Permanent Marker', cursive;
      background-color: #222;
      color: #fff;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      font-size: 3rem;
      color: #f5c400;
      text-shadow: 3px 3px 0 #000;
      margin-bottom: 10px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .pending-photos {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .photo-card {
      background-color: #333;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: transform 0.3s;
    }
    .photo-card:hover {
      transform: translateY(-5px);
    }
    .photo-img {
      width: 100%;
      height: 250px;
      object-fit: cover;
    }
    .photo-info {
      padding: 15px;
    }
    .photo-caption {
      font-family: 'Bangers', cursive;
      font-size: 1.5rem;
      color: #f5c400;
      margin-bottom: 10px;
    }
    .photo-meta {
      font-size: 0.9rem;
      color: #ccc;
      margin-bottom: 15px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      font-family: 'Bangers', cursive;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .approve-btn {
      background-color: #4CAF50;
      color: white;
    }
    .reject-btn {
      background-color: #f44336;
      color: white;
    }
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    .no-photos {
      text-align: center;
      padding: 50px;
      font-size: 1.5rem;
      color: #999;
    }
    .notification-settings {
      background-color: #333;
      border-radius: 10px;
      padding: 20px;
      margin-top: 30px;
    }
    .notification-settings h2 {
      font-size: 1.8rem;
      color: #f5c400;
      margin-bottom: 15px;
    }
    .notification-toggle {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .toggle-label {
      margin-left: 10px;
      font-size: 1.1rem;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #f5c400;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    .device-token {
      background-color: #444;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 0.8rem;
      word-break: break-all;
      margin-top: 10px;
      display: none;
    }
    
    /* Styles pour le formulaire de connexion */
    .login-container {
      max-width: 400px;
      margin: 50px auto;
      background-color: #333;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .login-title {
      font-size: 2rem;
      color: #f5c400;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 2px 2px 0 #000;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      color: #f5c400;
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #444;
      border-radius: 5px;
      background-color: #222;
      color: #fff;
      font-family: 'Permanent Marker', cursive;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    .form-input:focus {
      border-color: #f5c400;
      outline: none;
    }
    .login-btn {
      width: 100%;
      padding: 12px;
      background-color: #f5c400;
      color: #000;
      border: none;
      border-radius: 5px;
      font-family: 'Bangers', cursive;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    .login-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.3);
    }
    .error-message {
      color: #f44336;
      font-size: 0.9rem;
      margin-top: 5px;
      text-align: center;
    }
    .logout-btn {
      background-color: #f44336;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      font-family: 'Bangers', cursive;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .logout-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    .admin-content {
      display: none;
    }
    .login-form {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Formulaire de connexion -->
  <div id="login-form" class="login-container login-form">
    <h2 class="login-title">CONNEXION ADMIN</h2>
    <div id="login-error" class="error-message"></div>
    <form id="admin-login-form">
      <div class="form-group">
        <label for="username" class="form-label">Nom d'utilisateur</label>
        <input type="text" id="username" class="form-input" required>
      </div>
      <div class="form-group">
        <label for="password" class="form-label">Mot de passe</label>
        <input type="password" id="password" class="form-input" required>
      </div>
      <button type="submit" class="login-btn">SE CONNECTER</button>
    </form>
  </div>
  
  <!-- Contenu Admin (visible après connexion) -->
  <div id="admin-content" class="admin-content">
    <button id="logout-btn" class="logout-btn">DÉCONNEXION</button>
    
    <header>
      <h1>CLCH ADMIN</h1>
      <p>Validation des photos envoyées par les utilisateurs</p>
    </header>
    
    <div class="container">
      <div class="notification-settings">
        <h2>Notifications</h2>
        <div class="notification-toggle">
          <label class="toggle-switch">
            <input type="checkbox" id="notification-toggle">
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-label">Activer les notifications pour les nouvelles photos</span>
        </div>
        <p>Recevez des notifications sur votre téléphone lorsqu'une nouvelle photo est envoyée.</p>
        <div id="device-token" class="device-token"></div>
      </div>
      
      <h2>Photos en attente de validation</h2>
      <div id="pending-photos" class="pending-photos">
        <div class="no-photos">Aucune photo en attente de validation</div>
      </div>
    </div>
  </div>
  
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDDTsKpifjFMSSJrn20Xc3q8szf27F2ZP0",
      authDomain: "clch-3a8f4.firebaseapp.com",
      databaseURL: "https://clch-3a8f4-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "clch-3a8f4",
      storageBucket: "clch-3a8f4.firebasestorage.app",
      messagingSenderId: "258957198457",
      appId: "1:258957198457:web:2998d1c0f6ba295f3080a8",
      measurementId: "G-NWT4D2D1ER"
    };
    
    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Référence à la base de données
    const database = firebase.database();
    const pendingPhotosRef = database.ref('pendingPhotos');
    const approvedPhotosRef = database.ref('approvedPhotos');
    const adminUsersRef = database.ref('adminUsers');
    
    // Référence au stockage
    const storage = firebase.storage();
    
    // Référence à l'authentification
    const auth = firebase.auth();
    
    // Identifiants administrateur par défaut
    const DEFAULT_ADMIN = {
      username: "admin",
      password: "clch2024"
    };
    
    // Éléments du DOM
    const loginForm = document.getElementById('login-form');
    const adminContent = document.getElementById('admin-content');
    const adminLoginForm = document.getElementById('admin-login-form');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn');
    
    // Vérifier si l'utilisateur est déjà connecté
    function checkAuthState() {
      // Vérifier si les identifiants sont stockés dans le localStorage
      const savedUsername = localStorage.getItem('clch_admin_username');
      const savedAuthTime = localStorage.getItem('clch_admin_auth_time');
      
      if (savedUsername && savedAuthTime) {
        // Vérifier si l'authentification est encore valide (24 heures)
        const now = new Date().getTime();
        const authTime = parseInt(savedAuthTime);
        const authDuration = 24 * 60 * 60 * 1000; // 24 heures en millisecondes
        
        if (now - authTime < authDuration) {
          // L'authentification est encore valide
          showAdminContent();
          return;
        } else {
          // L'authentification a expiré
          localStorage.removeItem('clch_admin_username');
          localStorage.removeItem('clch_admin_auth_time');
        }
      }
      
      // Si on arrive ici, l'utilisateur n'est pas connecté
      showLoginForm();
    }
    
    // Afficher le formulaire de connexion
    function showLoginForm() {
      loginForm.style.display = 'block';
      adminContent.style.display = 'none';
    }
    
    // Afficher le contenu administrateur
    function showAdminContent() {
      loginForm.style.display = 'none';
      adminContent.style.display = 'block';
      
      // Initialiser les fonctionnalités admin
      initAdminFeatures();
    }
    
    // Initialiser les fonctionnalités admin
    function initAdminFeatures() {
      // Charger les photos en attente
      loadPendingPhotos();
      
      // Initialiser les notifications
      initNotifications();
    }
    
    // Initialiser les notifications
    function initNotifications() {
      try {
        // Vérifier si Firebase Messaging est disponible
        if (typeof firebase !== 'undefined' && firebase.messaging) {
          // Initialiser Firebase Messaging
          messaging = firebase.messaging();
          
          // Demander la permission pour les notifications
          const notificationToggle = document.getElementById('notification-toggle');
          
          // Vérifier si les notifications sont déjà autorisées
          if (Notification.permission === 'granted') {
            notificationToggle.checked = true;
            initMessaging();
          }
          
          // Gérer le changement d'état du toggle
          notificationToggle.addEventListener('change', function() {
            if (this.checked) {
              requestNotificationPermission();
            } else {
              // Désactiver les notifications
              console.log('Notifications désactivées');
              document.getElementById('device-token').style.display = 'none';
            }
          });
        } else {
          console.log("Firebase Messaging n'est pas disponible dans ce navigateur");
          // Masquer ou désactiver les éléments liés aux notifications
          const notificationSettings = document.querySelector('.notification-settings');
          if (notificationSettings) {
            notificationSettings.innerHTML = '<h2>Notifications</h2><p>Les notifications ne sont pas disponibles dans ce navigateur.</p>';
          }
        }
      } catch (error) {
        console.error("Erreur lors de l'initialisation de Firebase Messaging:", error);
        // Afficher un message d'erreur à l'utilisateur
        const notificationSettings = document.querySelector('.notification-settings');
        if (notificationSettings) {
          notificationSettings.innerHTML = '<h2>Notifications</h2><p>Une erreur est survenue lors de l\'initialisation des notifications.</p>';
        }
      }
    }
    
    // Gérer la soumission du formulaire de connexion
    adminLoginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      // Vérifier les identifiants
      checkAdminCredentials(username, password);
    });
    
    // Gérer la déconnexion
    logoutBtn.addEventListener('click', function() {
      // Supprimer les informations d'authentification
      localStorage.removeItem('clch_admin_username');
      localStorage.removeItem('clch_admin_auth_time');
      
      // Afficher le formulaire de connexion
      showLoginForm();
    });
    
    // Vérifier les identifiants administrateur
    function checkAdminCredentials(username, password) {
      // Simplifier la vérification pour éviter les problèmes de connexion à Firebase
      // Vérifier directement avec les identifiants par défaut
      if (username === DEFAULT_ADMIN.username && password === DEFAULT_ADMIN.password) {
        // Authentification réussie
        console.log('Authentification réussie avec les identifiants par défaut');
        
        // Stocker les informations d'authentification
        localStorage.setItem('clch_admin_username', username);
        localStorage.setItem('clch_admin_auth_time', new Date().getTime().toString());
        
        // Afficher le contenu administrateur
        showAdminContent();
        
        // Réinitialiser le formulaire
        adminLoginForm.reset();
        loginError.textContent = '';
        
        // Essayer d'enregistrer l'utilisateur dans la base de données (mais ne pas bloquer l'authentification)
        try {
          adminUsersRef.once('value')
            .then(snapshot => {
              if (!snapshot.exists()) {
                // Si aucun utilisateur admin n'existe dans la base de données, créer l'utilisateur par défaut
                adminUsersRef.push(DEFAULT_ADMIN)
                  .then(() => {
                    console.log('Utilisateur admin par défaut créé');
                  })
                  .catch(error => {
                    console.error('Erreur lors de la création de l\'utilisateur admin par défaut:', error);
                  });
              }
            })
            .catch(error => {
              console.error('Erreur lors de la vérification des utilisateurs admin:', error);
            });
        } catch (error) {
          console.error('Erreur lors de l\'accès à la base de données:', error);
        }
      } else {
        // Essayer de vérifier dans la base de données Firebase
        try {
          adminUsersRef.once('value')
            .then(snapshot => {
              let isAuthenticated = false;
              
              if (snapshot.exists()) {
                // Parcourir les utilisateurs admin dans la base de données
                snapshot.forEach(childSnapshot => {
                  const adminUser = childSnapshot.val();
                  
                  if (adminUser.username === username && adminUser.password === password) {
                    isAuthenticated = true;
                    return true; // Sortir de la boucle forEach
                  }
                });
              }
              
              if (isAuthenticated) {
                // Stocker les informations d'authentification
                localStorage.setItem('clch_admin_username', username);
                localStorage.setItem('clch_admin_auth_time', new Date().getTime().toString());
                
                // Afficher le contenu administrateur
                showAdminContent();
                
                // Réinitialiser le formulaire
                adminLoginForm.reset();
                loginError.textContent = '';
              } else {
                // Afficher un message d'erreur
                loginError.textContent = 'Identifiants incorrects. Veuillez réessayer.';
              }
            })
            .catch(error => {
              console.error('Erreur lors de la vérification des identifiants:', error);
              // En cas d'erreur, afficher un message plus précis
              loginError.textContent = 'Erreur de connexion à la base de données. Veuillez réessayer.';
            });
        } catch (error) {
          console.error('Erreur lors de l\'accès à la base de données:', error);
          loginError.textContent = 'Erreur de connexion à la base de données. Veuillez réessayer.';
        }
      }
    }
    
    // Demander la permission pour les notifications
    function requestNotificationPermission() {
      if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            console.log('Notification permission granted.');
            initMessaging();
          } else {
            console.log('Notification permission denied.');
            document.getElementById('notification-toggle').checked = false;
          }
        });
      }
    }
    
    // Initialiser Firebase Messaging
    function initMessaging() {
      if (!messaging) return;
      
      try {
        // Clé publique VAPID générée dans la console Firebase
        const vapidKey = "BK7R1KrKszxazAOe9PgHWgnFoUhW2niUY1e_ToFfTGH4dCI4Fw2zb7uxUAgV8nVhEx6GH8Ze28hfXMXJTMEZP7I";
        
        // Enregistrer manuellement le service worker pour Netlify
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
          .then(registration => {
            console.log('Service Worker enregistré avec succès:', registration.scope);
            
            // Récupérer le token FCM avec la clé VAPID
            return messaging.getToken({vapidKey: vapidKey});
          })
          .then((currentToken) => {
          if (currentToken) {
            console.log('FCM Token:', currentToken);
            // Afficher le token dans l'interface
            const deviceToken = document.getElementById('device-token');
            if (deviceToken) {
              deviceToken.textContent = currentToken;
              deviceToken.style.display = 'block';
            }
            
            // Enregistrer ce token dans la base de données
            try {
              saveTokenToDatabase(currentToken);
            } catch (error) {
              console.error('Erreur lors de l\'enregistrement du token:', error);
            }
          } else {
            console.log('No registration token available. Request permission to generate one.');
          }
        }).catch((err) => {
          console.log('An error occurred while retrieving token. ', err);
        });
        
        // Écouter les messages en premier plan
        messaging.onMessage((payload) => {
          console.log('Message received in foreground:', payload);
          try {
            // Afficher une notification personnalisée
            const notificationTitle = payload.notification.title || 'Nouvelle notification';
            const notificationOptions = {
              body: payload.notification.body || 'Vous avez reçu une nouvelle notification',
              icon: '/favicon.ico'
            };
            
            new Notification(notificationTitle, notificationOptions);
            
            // Rafraîchir la liste des photos en attente
            loadPendingPhotos();
          } catch (error) {
            console.error('Erreur lors de l\'affichage de la notification:', error);
          }
        });
      } catch (error) {
        console.error('Erreur dans initMessaging:', error);
      }
    }
    
    // Enregistrer le token dans la base de données
    function saveTokenToDatabase(token) {
      const adminTokensRef = database.ref('adminTokens');
      
      // Vérifier si ce token existe déjà
      adminTokensRef.orderByChild('token').equalTo(token).once('value', snapshot => {
        if (!snapshot.exists()) {
          // Le token n'existe pas, l'ajouter
          const newTokenRef = adminTokensRef.push();
          newTokenRef.set({
            token: token,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            platform: navigator.platform,
            userAgent: navigator.userAgent
          }).then(() => {
            console.log('Admin token saved to database');
          }).catch(error => {
            console.error('Error saving admin token to database:', error);
          });
        } else {
          console.log('Token already exists in database');
        }
      });
    }
    
    // Charger les photos en attente de validation
    function loadPendingPhotos() {
      const pendingPhotosContainer = document.getElementById('pending-photos');
      
      // Écouter les changements dans la liste des photos en attente
      pendingPhotosRef.on('value', snapshot => {
        // Vider le conteneur
        pendingPhotosContainer.innerHTML = '';
        
        // Vérifier s'il y a des photos en attente
        if (!snapshot.exists()) {
          pendingPhotosContainer.innerHTML = '<div class="no-photos">Aucune photo en attente de validation</div>';
          return;
        }
        
        // Parcourir les photos en attente
        snapshot.forEach(childSnapshot => {
          const photoData = childSnapshot.val();
          const photoId = childSnapshot.key;
          
          // Créer un élément pour chaque photo
          const photoElement = document.createElement('div');
          photoElement.className = 'photo-card';
          
          // Afficher les informations de la photo
          photoElement.innerHTML = `
            <img src="${photoData.imageUrl || 'placeholder.jpg'}" alt="Photo en attente" class="photo-img">
            <div class="photo-info">
              <div class="photo-caption">${photoData.caption || 'Sans légende'}</div>
              <div class="photo-meta">
                <p>Envoyée par: ${photoData.isGuest ? photoData.nickname : photoData.userAddress}</p>
                <p>Date: ${new Date(photoData.timestamp).toLocaleString()}</p>
              </div>
              <div class="action-buttons">
                <button class="btn approve-btn" onclick="approvePhoto('${photoId}')">Approuver</button>
                <button class="btn reject-btn" onclick="rejectPhoto('${photoId}')">Rejeter</button>
              </div>
            </div>
          `;
          
          pendingPhotosContainer.appendChild(photoElement);
        });
      });
    }
    
    // Approuver une photo
    function approvePhoto(photoId) {
      // Récupérer les données de la photo
      pendingPhotosRef.child(photoId).once('value', snapshot => {
        const photoData = snapshot.val();
        
        if (photoData) {
          // Déplacer la photo vers les photos approuvées
          approvedPhotosRef.push(photoData).then(() => {
            // Supprimer la photo des photos en attente
            pendingPhotosRef.child(photoId).remove().then(() => {
              alert('Photo approuvée avec succès !');
            }).catch(error => {
              console.error('Erreur lors de la suppression de la photo en attente:', error);
            });
          }).catch(error => {
            console.error('Erreur lors de l\'approbation de la photo:', error);
          });
        }
      });
    }
    
    // Rejeter une photo
    function rejectPhoto(photoId) {
      if (confirm('Êtes-vous sûr de vouloir rejeter cette photo ?')) {
        // Supprimer la photo des photos en attente
        pendingPhotosRef.child(photoId).remove().then(() => {
          alert('Photo rejetée avec succès !');
        }).catch(error => {
          console.error('Erreur lors du rejet de la photo:', error);
        });
      }
    }
    
    // Initialiser l'application au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      // Vérifier l'état d'authentification
      checkAuthState();
    });
  </script>
</body>
</html>